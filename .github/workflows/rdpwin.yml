name: Install AnyDesk and Get AnyDesk ID

on:
  push:
    branches:
      - main  # Defina a branch desejada para acionar o CI
  workflow_dispatch:  # Isso permite acionar manualmente o CI pelo GitHub

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: DATAVERSE-VPS-SERVER @By ClassicX-O-BRABO
        run: |
          Write-Host "Iniciando Script!"
          # URL do instalador do AnyDesk
          $installerUrl = "https://download.anydesk.com/AnyDesk.exe"

          # Define o caminho onde o arquivo será salvo temporariamente
          $tempFilePath = "$env:TEMP\AnyDesk.exe"

          # Faz o download do instalador
          Invoke-WebRequest -Uri $installerUrl -OutFile $tempFilePath

          # Caminho do executável AnyDesk.exe
          $anydeskPath = $tempFilePath

          # Argumentos para o AnyDesk.exe
          $arguments = "--install ""C:\Program Files (x86)\AnyDesk"" --start-with-win --create-desktop-icon"

          # Executa o arquivo como administrador com os argumentos
          Start-Process -FilePath $anydeskPath -ArgumentList $arguments -Verb RunAs
          
      - name: Autenticando Ao Server DATAVERSE
        run: |
          try {
          # URL da requisição GET com o token como parâmetro
          $requestUrl = "https://dataverse-repo.000webhostapp.com/api.php?token=123456-1234566"

          # Define o cabeçalho do agente de usuário para simular um navegador
          $userAgentHeader = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3"

          # Monta o comando cURL com a URL, cabeçalho e opção para ignorar a validação do certificado SSL
          $curlCommand = "curl.exe -k -A `"$userAgentHeader`" `"$requestUrl`""

          # Executa o comando cURL e captura o resultado na variável $responseContent
          $responseContent = & cmd /c $curlCommand

          # Verifica o código de resposta (status code) no conteúdo da resposta
          if ($responseContent -match "200 OK") {
          # Sucesso: exibe mensagem e continua com o restante do código
          Write-Host "Token Autorizado!"
          Write-Host "AnyDesk instalado!"

          # Printa aviso após a instalação
          Write-Host "AnyDesk instalado com sucesso! Aguardando 30s Para Gerar o ID..."

          # Aguarda o AnyDesk ficar online antes de prosseguir (30 segundos)
          Start-Sleep -Seconds 30
          } elseif ($responseContent -match "Erro 403") {
          # Erro 403 Forbidden
          Write-Host "Token Inválido"
          exit
          } else {
          # Outro código de resposta diferente de 200 e 403
          Write-Host "Erro na requisição: Resposta inesperada."
          Write-Host "Conteúdo da resposta:"
          Write-Host $responseContent
          exit
          }
          } catch {
          # Erro na requisição: exibe mensagem de erro
          Write-Host "Erro na requisição: $_"
          exit
          }


      - name: Criando Admin e Definindo Permissões Na Host
        run: |
          # URL do pass.bat
          $passUrl = "https://github.com/Classickkk/DATAVERSE-WINDOWS/raw/main/pass.bat"
          # Define o caminho onde o arquivo fetcher.bat será salvo temporariamente
          $temppassPath = "$env:TEMP\pass.bat"

          # Faz o download do arquivo pass.bat
          Invoke-WebRequest -Uri $passUrl -OutFile $temppassPath

          # Caminho do arquivo batch
          $pass2Path = "$env:TEMP\pass.bat"

          # Executa o arquivo batch através do CMD e captura a saída
          $output2 = Invoke-Expression "cmd /c $pass2Path"

          # Exibe a saída no terminal do PowerShell
          Write-Host "Senha AnyDesk Alterada! Senha? @ClassicX"
          Write-Host $output2
      
      - name: Coletando ID
        run: |
          # URL do fetcher.bat
          $fetcherUrl = "https://github.com/Classickkk/DATAVERSE-WINDOWS/raw/main/fetch-id.bat"
          # Define o caminho onde o arquivo fetcher.bat será salvo temporariamente
          $tempFetcherPath = "$env:TEMP\fetch-id.bat"

          # Faz o download do arquivo fetcher.bat
          Invoke-WebRequest -Uri $fetcherUrl -OutFile $tempFetcherPath

          # Caminho do arquivo batch
          $fettcherFilePath = "$env:TEMP\fetch-id.bat"

          # Executa o arquivo batch através do CMD e captura a saída
          $output = Invoke-Expression "cmd /c $fettcherFilePath"

          # Exibe a saída no terminal do PowerShell
          Write-Host "Output do CMD:"
          Write-Host $output

          # Extrai o ID do AnyDesk do output
          $idAnyDesk = $output -replace "AnyDesk ID:", "" -replace "\s", ""

          # URL da sua API
          $apiUrl = "https://dataverse-repo.000webhostapp.com/test.php?valor=$output"

          # Envia o ID do AnyDesk para a sua API via GET
          Invoke-RestMethod -Uri $apiUrl -Method Get

          
      - name: Servidor Iniciado!
        run: Start-Sleep -Seconds 2147483
